<div id="modals">
    <div class="modal fade" id="modal-add" tabindex="-1" role="basic" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                    <h4 class="modal-title">添加</h4>
                </div>
                <div class="modal-body">
                    <form action="javascript:;" id="form-add" method="post" onsubmit="false">
                        <div class="apply pcd">
                            <table class="table table-striped table-bordered " width="100%">
                                <tr>
                                    <th width="100">站点名称</th>
                                    <td><input type="text" class="form-control" name="stationName" max="16" value=""></td>
                                </tr>
                                <tr>
                                    <th width="100">医疗机构</th>
                                    <td>
                                        <select class="form-control  input-medium inline" name="institutionNo">
                                            <option>-- 请选择 --</option>
                                        </select>
                                        <input type="hidden" name="institutionName"/>
                                    </td>
                                </tr>
                                <tr>
                                    <th width="100">站点编号(限12位)</th>
                                    <td><input type="text" class="form-control" name="stationNo" max="16" value=""></td>
                                    <p><span class="required-star">* 请核对站点编号（具体站点编号）输入正确，创建后将不能修改</span></p>
                                </tr>
                                <tr width="100">
                                    <th>站点管理员</th>
                                    <td><input type="text" class="form-control" name="stationAdmin" max="32" value="">
                                    </td>
                                </tr>
                                <tr width="100">
                                    <th>管理员电话</th>
                                    <td>
                                        <input type="text" class="form-control input-medium" name="adminPhone"/>
                                    </td>
                                </tr>
                                <tr>
                                    <th>站点介绍图</th>
                                    <td>
                                        <div class="pull-left">
                                            <input type="file" class="hidden">
                                            <a href="javascript:;" style="width: 100px;height: 100px;" class="btn-upload">
                                                <span>选择图片</span>
                                                <img name="stationBanner" src="../../images/def.png" width="100" height="100">
                                            </a>
                                            <input type="hidden" name="stationBanner" value=""/>
                                            <p><span class="required-star">* 建议尺寸：220*220px，大小不超过150k</span></p>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th>站点地址</th>
                                    <td>
                                        <select name="provinceId"
                                                class="prov form-control input-small inline margin-bottom-10">
                                        </select>
                                        <select name="cityId"
                                                class="city form-control input-small inline margin-bottom-10"
                                                style="display: none">
                                        </select>
                                        <select name="distId"
                                                class="dist form-control input-small inline margin-bottom-10"
                                                style="display: none">
                                        </select>
                                        <input type="text" class="form-control" placeholder="镇" name="town"/>
                                    </td>
                                </tr>
                                <tr width="100">
                                    <th>详细地址</th>
                                    <td>
                                        <input type="text" class="form-control" placeholder="详细地址" name="addressDetail"/>
                                    </td>
                                </tr>
                                <tr>
                                    <th>站点简介：</th>
                                    <td colspan="3">
                                        <div id="editor-trigger" style="height: 450px;max-width: 450px;">
                                            <p>请输入内容...</p>
                                        </div>
                                        <input type="hidden" id="content" name="introduction"/>
                                    </td>
                                </tr>
                                <tr width="100">
                                    <th>绑定设备类型</th>
                                    <td class="addDevice">

                                    </td>
                                </tr>
                            </table>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="type" class="btn dark green btn-save radius6" onclick="setIntroductionAdd()"><i class="fa fa-save"></i> 添加</button>
                    <button type="button" class="btn dark btn-outline radius6" data-dismiss="modal"><i
                            class="fa fa-close"></i> 关闭
                    </button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>


    <div class="modal fade" id="modal-edit" tabindex="-1" role="basic" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                    <h4 class="modal-title">修改</h4>
                </div>
                <div class="modal-body">
                    <form action="javascript:;" id="form-edit" method="post" onsubmit="false">
                        <input type="hidden" name="id"/>
                        <div class="apply pcd2">
                            <table class="table table-striped table-bordered " width="100%">
                                <tr>
                                    <th width="100">站点名称</th>
                                    <td><input type="text" class="form-control" name="stationName" max="16" value="" readonly></td>
                                </tr>
                                <tr>
                                    <th width="100">医疗机构</th>
                                    <td>
                                        <select class="form-control  input-medium inline" name="institutionNo" disabled>
                                            <option value="">-- 请选择 --</option>
                                        </select>
                                        <input type="hidden" name="institutionName"/>
                                    </td>
                                    <!--<td>-->
                                        <!--<input type="text" class="form-control" name="institutionName" max="16" value="" readonly>-->
                                    <!--</td>-->
                                </tr>
                                 <tr>
                                    <th width="100">站点编号(限12位)</th>
                                    <td><input type="text" class="form-control" name="stationNo" max="16" value="" readonly></td>
                                     <p><span class="required-star">* 请核对站点编号（具体站点编号）输入正确，创建后将不能修改</span></p>
                                </tr>
                                <tr width="100">
                                    <th>站点管理员</th>
                                    <td><input type="text" class="form-control" name="stationAdmin" max="32" value="">
                                    </td>
                                </tr>
                                <tr width="100">
                                    <th>管理员电话</th>
                                    <td>
                                        <input type="text" class="form-control input-medium" name="adminPhone"/>
                                    </td>
                                </tr>
                                <tr>
                                    <th>站点介绍图</th>
                                    <td>
                                        <div class="pull-left">
                                            <input type="file" class="hidden">
                                            <a href="javascript:;" style="width: 100px;height: 100px;" class="btn-upload">
                                                <span>选择图片</span>
                                                <img name="stationBanner" src="../../images/def.png" width="100" height="100">
                                            </a>
                                            <input type="hidden" name="stationBanner" value=""/>
                                            <p><span class="required-star">* 建议尺寸：220*220px，大小不超过150k</span></p>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th>站点地址</th>
                                    <td>
                                        <select name="provinceId"
                                                class="prov form-control input-small inline margin-bottom-10">
                                        </select>
                                        <select name="cityId"
                                                class="city form-control input-small inline margin-bottom-10"
                                                style="display: none">
                                        </select>
                                        <select name="distId"
                                                class="dist form-control input-small inline margin-bottom-10"
                                                style="display: none">
                                        </select>
                                        <input type="text" class="form-control" placeholder="镇" name="town"/>
                                    </td>
                                </tr>
                                <tr width="100">
                                    <th>详细地址</th>
                                    <td>
                                        <input type="text" class="form-control" placeholder="详细地址" name="addressDetail"/>
                                    </td>
                                </tr>
                                <tr>
                                    <th>站点简介：</th>
                                    <td colspan="3">
                                        <div id="editor-trigger2" style="height: 450px;max-width: 450px;">
                                            <p >请输入内容...</p>
                                        </div>
                                        <input type="hidden" id="content2" name="introduction"/>
                                    </td>
                                </tr>
                                <tr width="100">
                                    <th>绑定设备类型</th>
                                    <td class="addDevice">

                                    </td>
                                </tr>
                            </table>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn dark green btn-save radius6" onclick="setIntroductionEdit()()"><i class="fa fa-check"></i> 保存
                    </button>
                    <button type="button" class="btn dark btn-outline radius6" data-dismiss="modal"><i
                            class="fa fa-close"></i> 关闭
                    </button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
</div>
<div class="row">
    <div class="top-handle-btn">
        <form id="search-form" action="javascript:;">
            <button class="btn-sm btn radius6 search">
                <i class="fa fa-refresh"></i>
            </button>
            <select name="pageSize" class="form-control page-size  input-small inline">
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
            </select>
            <input type="text" placeholder="站点名称查询" class="form-control input-inline" name="stationName"/>
            <button class="btn purple right search radius6"><i class="fa fa-search"></i> 查询</button>
            <a class='btn green radius6' data-toggle='modal' href='#modal-add' onclick="clickclear()"><i class="fa fa-plus"></i> 添加</a>
        </form>
    </div>
</div>

<div class="modal fade" id="modal-show" tabindex="-1" role="basic" aria-hidden="true">
    <div class="modal-dialog" style="width: 400px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">绑定的设备</h4>
            </div>
            <div class="modal-body">
                <form action="javascript:;" method="post" name="updateExpress">
                    <input type="hidden" name="id">
                    <table class="table table-striped table-bordered " width="100%">
                        <thead>
                        <tr>
                            <th>类型名称</th>
                            <th>设备码</th>
                        </tr>
                        </thead>
                        <tbody class="checkDeviceType">

                        </tbody>
                    </table>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn dark btn-outline radius6" data-dismiss="modal"><i
                        class="fa fa-close"></i> 关闭
                </button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>





<div class="row">
    <table id="data-table" class="table table-striped table-bordered table-hover" width="100%">
        <thead>
        <tr>
            <th>站点名称</th>
            <th>所属医疗机构</th>
            <th>站点编码</th>
            <th>站点管理员</th>
            <th>管理员电话</th>
            <th>省/直辖市</th>
            <th>城市</th>
            <th>区县</th>
            <th>镇</th>
            <th>详细地址</th>
            <th>绑定设备类型</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
        <tfoot>
        </tfoot>
    </table>
</div>

<script type="text/javascript" src="js/wangEditor.min.js"></script>
<script type="text/javascript">
    var url = "/basic/station";

    function init() {

        $(".pcd").citySelect({nodata: "none", required: false});
        $(".pcd2").citySelect({nodata: "none", required: false});

        DataTable.init({
            url: url,//ajax请求url
            tableName: "data-table",//数据表table id
            paramsFormName: "search-form",//查询参数form id
            modal: "modals",//模态框div
            columns: [//列对应的字段数组，注意顺序
                {data: "stationName"},
                {data: "institutionNo",replaceFn: "getInstitutionName"},
                {data: "stationNo"},
                {data: "stationAdmin"},
                {data: "adminPhone"},
                {data: "provinceId", replaceFn: "city.getProvinceName"},
                {data: "cityId", replaceFn: "city.getCityName"},
                {data: "distId", replaceFn: "city.getDistName"},
                {data: "town"},
                {data: "addressDetail"},
                {data: "id",replaceFn: "getType"}
            ],
            options: [//操作区域(id)
                {
                    icon: 'fa fa-edit',
                    name: "编辑",
                    color: "green",
                    option: "modal-edit",
                    edit: true,
                    url: url,
                    editMain: true,
                    pre: "checkDeviceType"

                },
                {
                    icon: 'fa fa-remove',
                    name: "删除",
                    color: "red",
                    del: url,
                    msg: "确定要删除该站点吗？"
                },
            ],
            handles: {
                insert: [
                    {url: url, modalId: "modal-add"},
                ],
            },
        });

    };
    function clickclear(){
        // $("#modal-add").find("select[name]").val('');
        $("#modal-add").find("*[type=checkbox]").prop("checked",false);
    }

    function getType(id){
       return '<a onclick="checkDeviceType(\''+id+'\',1)" ><i class="fa fa-list-alt"></i></a>'
    }

    function checkDeviceType(id,con){
        getIntrodution(id);
        var stationNo = $("tr[data-id="+id+"]").find("td[data-name=stationNo]").attr("data-value");
        if(con===1){
            $(".checkDeviceType").html("");
        }else{
            $("#modal-edit").find("*[type=checkbox]").prop("checked",false);
        }
        Shinez.get("/basic/stationDeviceType?stationNo="+stationNo,function (ret) {
            $.each(ret, function (k, v) {
                if(con===1){
                    $(".checkDeviceType").append("<tr></tr><td>"+v.typeName+"</td><td>"+v.identCode+"</td></tr>");
                }else{
                    $("#modal-edit").find("input[value='"+v.identCode+"']").prop("checked",true);
                }
            });
        })
        if(con==1){
          $('#modal-show').modal("show");
        }
    }

    $(function () {
        loadInstitutionTypes();
        loadDeviceTypes();
        init();
        registerImageUploadComponent();
        Shinez.get("/main/qiniu-token", function (ret) {
            var token = ret.data.uploadToken;
            var domain = ret.data.domain;
            initEditor1(token, domain);
        });

        Shinez.get("/main/qiniu-token", function (ret) {
            var token = ret.data.uploadToken;
            var domain = ret.data.domain;
            initEditor2(token, domain);
        });

    });


    function setIntroductionAdd() {
        var html = editor.$txt.html();
        $("input[name='introduction']").val(html);



        console.log('form',$('#form-add').serialize());

        console.log('html',html);
        $('form-add').submit();
    }

    function setIntroductionEdit() {
        var html = editor2.$txt.html();
        $("input[name='introduction']").val(html);
        console.log(html);
        $('form-edit').submit();

    };

    function getInstitutionName(code) {
        let val=$("select[name=institutionNo]").find("option[value="+code+"]").html()
        if(val){
            return val
        }else{
            return '-'
        }
    }

    function getIntrodution(id){
        for (var i=0;i<(DataTable.getData().length);i++){
            if(DataTable.getData()[i].id == id){
                editor2.$txt.html(DataTable.getData()[i].introduction)
            }
        }
    }

    function loadInstitutionTypes() {
        Shinez.get("/basic/allInstitution",function (ret) {
            $.each(ret, function (k, v) {
                $("select[name=institutionNo]").append("<option value='" + v.institutionNo + "'>" + v.institutionName + "</option>");
            });
        })
    }

    function loadDeviceTypes() {
        Shinez.get("/basic/allDeviceType",function (ret) {
            $.each(ret, function (k, v) {
                // console.log(v)
                $(".addDevice").append("<label class='mt-checkbox'><input type='checkbox' class='no-init' name='types["+k+"].identCode' value='" + v.identCode + "'>" + v.typeName + "<span><span></span></span></label>&nbsp;&nbsp;&nbsp;");
            });
        })
    }

    function initEditor1(token, domain) {
        editor = new wangEditor('editor-trigger');
        editor.config.customUpload = true;  // 设置自定义上传的开关
        editor.config.customUploadInit = function () {
            QiniuInit.init(editor, token, domain);
        };
        // 取消粘贴过滤
        editor.config.pasteFilter = false;
        // 关闭js过滤
        editor.config.jsFilter = false;
        editor.config.menus = $.map(wangEditor.config.menus, function (item, key) {
            if (item === 'fullscreen') {
                return null;
            }
            if (item === 'location') {
                return null;
            }
            return item;
        });
        editor.create();

    }

    function initEditor2(token, domain) {
        editor2 = new wangEditor('editor-trigger2');
        editor2.config.customUpload = true;  // 设置自定义上传的开关
        editor2.config.customUploadInit = function () {
            QiniuInit.init(editor2, token, domain);
        };
        // 取消粘贴过滤
        editor2.config.pasteFilter = false;
        // 关闭js过滤
        editor2.config.jsFilter = false;
        editor2.config.menus = $.map(wangEditor.config.menus, function (item, key) {
            if (item === 'fullscreen') {
                return null;
            }
            if (item === 'location') {
                 return null;
            }
            return item;
        });

        editor2.create();
    }

    function addStation() {
        loadHtml("/basic/station_add");
    }

    function editStation(id) {
        history.state.params = id;
        loadHtml("/basic/station_edit");
    }
</script>
